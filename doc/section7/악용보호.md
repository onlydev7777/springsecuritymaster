# 악용보호

## CORS (Cross Origin Resource Sharing)

- A사이트(localhost:8080) 에서 B사이트(localhost:8081) 의 데이터를 직접 호출하는 것을 제한
- 만약 이를 "허가" 하기 위해서는 B사이트(서버)에서 CORS 설정 필요

![CORS-case.png](CORS-case.png)

#### CORS 종류

##### 1. Simple Request

- SimpleRequest는 예비 요청(Preflight Request) 과정 없이 다이렉트로 본 요청하는 방식
- 서버가 응답 헤더에 Access-Control-Allow-Origin 값을 전송하면 브라우저가 CORS 정책 체킹

###### 제약사항

- GET, POST, HEAD 메서드만 가능
- 헤더 Key는 Accept, Accept-Language, Content-Language, Content-Type, DPR, Downlink, Save-Data,
  Viewport-Width Width 만 가능
- Content-type 은 application/x-www-form-urlencoded, multipart/form-data, text/plain 만 가능

![CORS-Simple Request.png](CORS-Simple Request.png)

##### 2. Preflight Request (예비요청)

- 요청을 한번에 보내지 않고, 예비 요청(OPTION METHOD)과 본 요청으로 나누어서 Request
- 브라우저가 스스로 안전한 요청인지 확인하는 것으로 요청 사항이 Simple Request에 해당하지 않을 경우 브라우저가 Preflight Request 실행

![CORS-Preflight Request.png](CORS-Preflight Request.png)

#### CORS 기준

- 프로토콜, 호스트, 포트가 동일해야 함
- 그 외에는 CORS 정책 검증 대상

#### CORS 허용 방법 - 서버에서 Access-Control-Allow-* 세팅

- Access-Control-Allow-Origin
    - 헤더에 작성된 URL만 브라우저가 리소스를 접근할 수 있도록 허용
    - https://security.io, *(전체)

- Access-Control-Allow-Methods
    - preflight request 에 대한 응답으로 실제 요청 중에 사용할 수 있는 메서드를 나타낸다
    - default) GET, POST, HEAD, OPTIONS
    - ex) PUT, *

- Access-Control-Allow-Headers
    - preflight request 에 대한 응답으로 실제 요청 중에 사용할 수 있는 헤더 필드 이름을 나타낸다
    - default) Origin,Accept,X-Requested-With,Content-Type,
      Access-Control-Request-Method,Access-Control-Request-Headers
    - ex) [Custom-Header], *

- Access-Control-Allow-Credentials
    - 실제 요청에 쿠기나 인증 등의 사용자 자격 증명이 포함될 수 있음을 나타낸다.
    - Client의 credentials:include 옵션일 경우 true 는 필수

- Access-Control-Max-Age
    - preflight 요청 결과를 캐시 할 수 있는 시간을 나타내는 것으로 해당 시간동안은 preflight 요청을 다시 하지 않게 된다

#### cors()

- CORS의 예비요청(Preflight Requsest) 에는 쿠키(JSESSIONID)가 포함되어 있지 않기 때문에 Spring Security 이전에 처리 되어야 한다.
- CORS가 먼저 처리 되도록 CorsFilter를 사용할 수 있으며 CorsConfigurationSource를 제공함으로써 Spring Security와 통합할 수 있다.

```java

@EnableWebSecurity
@Configuration
public class SecurityConfig {

  @Bean
  public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {

    http
        .cors(cors -> cors
            .configurationSource(corsConfigurationSource())
        )
    ;

    return http.build();
  }

  private CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration configuration = new CorsConfiguration();
    configuration.addAllowedOrigin("https://example.com");
    configuration.addAllowedMethod("GET");
    configuration.addAllowedMethod("POST");
    configuration.setAllowCredentials(true);
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
    source.registerCorsConfiguration("/**", configuration);

    return source;
  }
}
```

```java
/**
 * CorsConfigurationSource가 설정되지 않으면 Spring MVC CORS 구성 사용
 * @param <H>
 */
public class CorsConfigurer<H extends HttpSecurityBuilder<H>> extends
    AbstractHttpConfigurer<CorsConfigurer<H>, H> {

  @Override
  public void configure(H http) {
    ApplicationContext context = http.getSharedObject(ApplicationContext.class);
    CorsFilter corsFilter = getCorsFilter(context);
    Assert.state(corsFilter != null,
        () -> "Please configure either a " + CORS_FILTER_BEAN_NAME + " bean or a "
            + CORS_CONFIGURATION_SOURCE_BEAN_NAME + "bean.");
    http.addFilter(corsFilter);
  }

  private CorsFilter getCorsFilter(ApplicationContext context) {
    if (this.configurationSource != null) {
      return new CorsFilter(this.configurationSource);
    }
    boolean containsCorsFilter = context.containsBeanDefinition(CORS_FILTER_BEAN_NAME);
    if (containsCorsFilter) {
      return context.getBean(CORS_FILTER_BEAN_NAME, CorsFilter.class);
    }
    boolean containsCorsSource = context.containsBean(CORS_CONFIGURATION_SOURCE_BEAN_NAME);
    if (containsCorsSource) {
      CorsConfigurationSource configurationSource = context.getBean(
          CORS_CONFIGURATION_SOURCE_BEAN_NAME,
          CorsConfigurationSource.class);
      return new CorsFilter(configurationSource);
    }
    if (mvcPresent) {
      return MvcCorsFilter.getMvcCorsFilter(context);
    }
    return null;
  }
}
```

## CSRF (Cross Site Request Forgery)